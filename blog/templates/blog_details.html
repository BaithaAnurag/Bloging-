{% extends "base.html" %}
{% load static %}

{% block title %}{{ blog.meta_title|default:blog.title }}{% endblock %}

{% block meta %}
<meta name="description" content="{{ blog.meta_description|default:blog.excerpt|truncatewords:25 }}">
<meta name="keywords" content="{{ blog.keywords|default:'AI, Tech, Machine Learning, Innovation, Blog' }}">
<meta property="og:title" content="{{ blog.title }}">
<meta property="og:description" content="{{ blog.meta_description|default:blog.excerpt|truncatewords:25 }}">
<meta property="og:type" content="article">
{% if blog.image %}
<meta property="og:image" content="{{ blog.image.url }}">
{% endif %}
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<link rel="canonical" href="{{ request.build_absolute_uri }}">
<meta name="author" content="{{ blog.author }}">
{% endblock %}

{% block content %}
<style>
/* ============================================================
   THEME VARIABLES (Light + Dark)
============================================================ */
:root {
  --bg-color: #ffffff;
  --text-color: #222;
  --heading-color: #111;
  --muted-text: #666;
  --caption-color: #777;
  --bg-secondary: #f5f5f5;
  --card-shadow: rgba(0,0,0,0.08);
}

body.dark-mode {
  --bg-color: #0d0d0d;
  --text-color: #eaeaea;
  --heading-color: #fff;
  --muted-text: #b3b3b3;
  --caption-color: #999;
  --bg-secondary: #1a1a1a;
  --card-shadow: rgba(255,255,255,0.05);
}

/* ============================================================
   BLOG CONTAINER
============================================================ */
.blog-container {
  max-width: 900px;
  margin: 70px auto;
  padding: 30px;
  border-radius: 14px;
  background: var(--bg-color);
  color: var(--text-color);
  line-height: 1.75;
  font-size: 1.07rem;
  transition: 0.3s;
}

.blog-container h1, h2, h3, h4, h5, h6 {
  color: var(--heading-color);
  font-weight: 700;
}

/* Meta info */
.blog-meta { color: var(--muted-text); font-size: 0.95rem; margin-bottom: 20px; }

/* Blog images */
.blog-container img,
.blog-container video,
.blog-container iframe {
  width: 100%;
  border-radius: 12px;
  margin: 25px 0;
  box-shadow: 0 4px 15px var(--card-shadow);
  transition: 0.25s ease;
}

.blog-container img:hover { transform: scale(1.015); }

.media-caption { font-size: 0.85rem; color: var(--caption-color); text-align: center; margin-top: 6px; }

/* Table of Contents */
#toc {
  background: var(--bg-secondary);
  padding: 15px 20px;
  border-radius: 10px;
  margin-bottom: 30px;
}
#toc h3 { margin-bottom: 10px; }
#toc ul { list-style: none; padding-left: 0; }
#toc ul li { margin: 6px 0; }

/* Social share */
.social-share {
  margin: 40px 0;
}
.social-share a {
  display: inline-block;
  margin-right: 15px;
  padding: 10px 15px;
  border-radius: 6px;
  text-decoration: none;
  color: #fff;
  font-weight: 600;
  transition: 0.3s;
}
.social-share a.facebook { background: #3b5998; }
.social-share a.twitter { background: #1da1f2; }
.social-share a.linkedin { background: #0a66c2; }
.social-share a:hover { opacity: 0.85; }

/* Navigation */
.blog-nav {
  display: flex;
  justify-content: space-between;
  margin: 40px 0;
}
.blog-nav a {
  text-decoration: none;
  color: var(--primary, #4f46e5);
  font-weight: 600;
  transition: 0.3s;
}
.blog-nav a:hover { text-decoration: underline; }

/* Related posts */
.related-blogs { margin-top: 60px; }
.related-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; }
.related-card { background: var(--bg-secondary); border-radius: 10px; overflow: hidden; box-shadow: 0 3px 10px var(--card-shadow); text-decoration: none; color: inherit; transition: 0.25s; }
.related-card:hover { transform: translateY(-4px); }
.related-card img { width: 100%; height: 180px; object-fit: cover; }
.related-card-content { padding: 15px; }
.related-card-content h3 { margin-bottom: 6px; font-size: 1.1rem; }

/* Comments */
.comment-section { margin-top: 60px; padding-top: 30px; border-top: 1px solid var(--muted-text); }
.comment { background: var(--bg-secondary); padding: 15px 18px; border-radius: 10px; margin-bottom: 15px; }
.comment strong { color: var(--heading-color); }
.comment-form input, .comment-form textarea {
  width: 100%;
  background: var(--bg-color);
  border: 1px solid var(--muted-text);
  padding: 12px;
  border-radius: 10px;
  margin-bottom: 12px;
  color: var(--text-color);
}
.comment-form input:focus, .comment-form textarea:focus { border-color: #4f46e5; }
.comment-form button { background: #4f46e5; color: #fff; padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; }
.comment-form button:hover { background: #3d37c5; }

/* Responsive */
@media (max-width: 768px) {
  .blog-container { padding: 18px; }
  .related-card img { height: 150px; }
}
</style>

<article class="blog-container" itemscope itemtype="https://schema.org/BlogPosting">

  <!-- Header -->
  <header>
    <h1 itemprop="headline">{{ blog.title }}</h1>
    <p class="blog-meta">
      <i class="bi bi-person"></i> {{ blog.author }} •
      <time itemprop="datePublished" datetime="{{ blog.created_at|date:'Y-m-d' }}">{{ blog.created_at|date:"F j, Y" }}</time>
    </p>
  </header>

  <!-- Featured Image -->
  {% if blog.image %}
  <img src="{{ blog.image.url }}" alt="{{ blog.title }}" itemprop="image">
  {% endif %}

  <!-- Table of Contents -->
  <div id="toc">
    <h3>Table of Contents</h3>
    <ul id="toc-list"></ul>
  </div>

  <!-- Article Content -->
  <section id="blog-content" itemprop="articleBody">
    {{ blog.content|safe }}
  </section>

  <!-- Social Share -->
  <div class="social-share">
    <a class="facebook" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}">Facebook</a>
    <a class="twitter" target="_blank" href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ blog.title }}">Twitter</a>
    <a class="linkedin" target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.build_absolute_uri }}&title={{ blog.title }}">LinkedIn</a>
  </div>

  <!-- Next/Previous -->
  <div class="blog-nav">
    {% if previous_post %}
      <a href="{% url 'blog_detail' previous_post.slug %}">← {{ previous_post.title }}</a>
    {% else %}
      <span></span>
    {% endif %}
    {% if next_post %}
      <a href="{% url 'blog_detail' next_post.slug %}">{{ next_post.title }} →</a>
    {% else %}
      <span></span>
    {% endif %}
  </div>

  <!-- Related Posts -->
  {% if related_posts %}
  <section class="related-blogs">
    <h2>Related Posts</h2>
    <div class="related-grid">
      {% for related in related_posts %}
      <a href="{% url 'blog_detail' related.slug %}" class="related-card">
        {% if related.image %}<img src="{{ related.image.url }}" alt="{{ related.title }}">{% endif %}
        <div class="related-card-content">
          <h3>{{ related.title }}</h3>
          <p>{{ related.excerpt|truncatewords:20 }}</p>
        </div>
      </a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- Comments -->
  <section class="comment-section">
    <h3>Comments (<span id="comment-count">{{ comments.count }}</span>)</h3>
    <div id="comment-list">
      {% for c in comments %}
      <div class="comment">
        <strong>{{ c.name }}</strong>
        <small> — {{ c.created_at|date:"F j, Y, g:i a" }}</small>
        <p>{{ c.text }}</p>
      </div>
      {% empty %}<p>No comments yet. Be the first!</p>{% endfor %}
    </div>

    <form id="comment-form" class="comment-form">
      {% csrf_token %}
      <h4>Leave a Comment</h4>
      <input type="text" name="name" placeholder="Your Name" required>
      <input type="email" name="email" placeholder="Your Email" required>
      <textarea name="text" rows="4" placeholder="Write a comment..." required></textarea>
      <button type="submit">Post Comment</button>
    </form>
  </section>
</article>

<script>
// Table of Contents auto-generate
document.addEventListener("DOMContentLoaded", () => {
  const tocList = document.getElementById("toc-list");
  const content = document.getElementById("blog-content");
  const headings = content.querySelectorAll("h2, h3, h4");
  headings.forEach((h, i) => {
    const id = "heading-" + i;
    h.id = id;
    const li = document.createElement("li");
    li.style.marginLeft = h.tagName === "H3" ? "15px" : "0";
    li.innerHTML = `<a href="#${id}">${h.textContent}</a>`;
    tocList.appendChild(li);
  });

  // Smooth scrolling
  tocList.querySelectorAll("a").forEach(link => {
    link.addEventListener("click", e => {
      e.preventDefault();
      document.getElementById(link.getAttribute("href").substring(1)).scrollIntoView({ behavior: "smooth" });
    });
  });
});

// AJAX comment submission
const form = document.getElementById("comment-form");
const list = document.getElementById("comment-list");
const count = document.getElementById("comment-count");
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(form);
  const res = await fetch("", { method: "POST", headers: { "X-Requested-With": "XMLHttpRequest" }, body: formData });
  const data = await res.json();
  if (data.success) {
    const div = document.createElement("div");
    div.classList.add("comment");
    div.innerHTML = `<strong>${data.name}</strong><small> — just now</small><p>${data.text}</p>`;
    list.prepend(div);
    form.reset();
    count.textContent = parseInt(count.textContent)+1;
  }
});
</script>

{% endblock %}
